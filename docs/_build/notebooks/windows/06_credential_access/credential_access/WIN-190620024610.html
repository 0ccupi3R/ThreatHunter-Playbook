---
redirect_from:
  - "/notebooks/windows/06-credential-access/credential-access/win-190620024610"
interact_link: content/notebooks/windows/06_credential_access/credential_access/WIN-190620024610.ipynb
kernel_name: 
kernel_path: content/notebooks/windows/06_credential_access/credential_access
has_widgets: false
title: |-
  Domain DPAPI Backup Key Extraction
pagenum: 22
prev_page:
  url: /notebooks/windows/06_credential_access/credential_access.html
next_page:
  url: /notebooks/windows/06_credential_access/credential_access/WIN-190725024610.html
suffix: .ipynb
search: key domain dpapi backup master com github mimikatz data user playbook masterkey controller sigma description password hunters forge threathunter tree security blob l windows protection generated docs analytic fp rate log channel low c id microsoft system api generates protected users used computer member mechanism allow unprotection public any logon event signature signatures yml gentilkiwi abacddddceafeaf modules kuhlmlsadump operating provide pair calls called uses process client decrypt ms content library md analytics file bckupkey every attempted communicates windpapidomainbackupkeyextraction winprotectedstorageserviceaccess windpapidomainmasterkeybackupattempt en us sharpdpapi extraction metadata win author roberto rodriguez cybrwardg creation date platform link technical starting began application programming interface

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Domain DPAPI Backup Key Extraction</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Metadata">Metadata<a class="anchor-link" href="#Metadata"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">WIN-190620024610</td>
</tr>
<tr>
<td style="text-align:left">author</td>
<td style="text-align:left">Roberto Rodriguez @Cyb3rWard0g</td>
</tr>
<tr>
<td style="text-align:left">creation date</td>
<td style="text-align:left">2019/06/20</td>
</tr>
<tr>
<td style="text-align:left">platform</td>
<td style="text-align:left">Windows</td>
</tr>
<tr>
<td style="text-align:left">playbook link</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Technical-Description">Technical Description<a class="anchor-link" href="#Technical-Description"> </a></h2><p>Starting with Microsoft® Windows® 2000, the operating system began to provide a data protection application-programming interface (API).
This Data Protection API (DPAPI) is a pair of function calls (CryptProtectData / CryptUnprotectData) that provide operating system-level data protection services to user and system processes.
DPAPI initially generates a strong key called a MasterKey, which is protected by the user's password. DPAPI uses a standard cryptographic process called Password-Based Key Derivation to generate a key from the password.
This password-derived key is then used with Triple-DES to encrypt the MasterKey, which is finally stored in the user's profile directory.</p>
<p>When a computer is a member of a domain, DPAPI has a backup mechanism to allow unprotection of the data. When a MasterKey is generated, DPAPI talks to a Domain Controller.
Domain Controllers have a domain-wide public/private key pair, associated solely with DPAPI. The local DPAPI client gets the Domain Controller public key from a Domain Controller by using a mutually authenticated and privacy protected RPC call. The client encrypts the MasterKey with the Domain Controller public key. It then stores this backup MasterKey along with the MasterKey protected by the user's password.
If an adversary obtains domain admin (or equivalent) privileges, the domain backup key can be stolen and used to decrypt any domain user master key.
Tools such as Mimikatz with the method/module lsadump::backupkeys can be used to extract the domain backup key.
It uses the LsaOpenPolicy/LsaRetrievePrivateData API calls (instead of MS-BKRP) to retrieve the value for the G$BCKUPKEY_PREFERRED and G$BCKUPKEY_P LSA secrets.</p>
<p>Additional reading</p>
<ul>
<li><a href="https://github.com/hunters-forge/ThreatHunter-Playbook/tree/master/docs/content/library/data_protection_api.md">https://github.com/hunters-forge/ThreatHunter-Playbook/tree/master/docs/content/library/data_protection_api.md</a></li>
<li><a href="https://github.com/hunters-forge/ThreatHunter-Playbook/tree/master/docs/content/library/lsa_policy_objects.md">https://github.com/hunters-forge/ThreatHunter-Playbook/tree/master/docs/content/library/lsa_policy_objects.md</a></li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hypothesis">Hypothesis<a class="anchor-link" href="#Hypothesis"> </a></h2><p>Adversaries might be extracting the DPAPI domain backup key from my DC to be able to decrypt any domain user master key files.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analytics">Analytics<a class="anchor-link" href="#Analytics"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialize-Analytics-Engine">Initialize Analytics Engine<a class="anchor-link" href="#Initialize-Analytics-Engine"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">openhunt.mordorutils</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Download-&amp;-Process-Mordor-File">Download &amp; Process Mordor File<a class="anchor-link" href="#Download-&amp;-Process-Mordor-File"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mordor_file</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/hunters-forge/mordor/master/small_datasets/windows/credential_access/credential_dumping_T1003/credentials_from_ad/empire_mimikatz_export_master_key.tar.gz&quot;</span>
<span class="n">registerMordorSQLTable</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">mordor_file</span><span class="p">,</span> <span class="s2">&quot;mordorTable&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Analytic-I">Analytic I<a class="anchor-link" href="#Analytic-I"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left">FP Rate</th>
<th style="text-align:left">Log Channel</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Low</td>
<td style="text-align:left">['Security']</td>
<td style="text-align:left">Monitor for any SecretObject with the string BCKUPKEY in the ObjectName</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT `@timestamp`, computer_name, ObjectServer, ObjectType, ObjectName</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">WHERE channel = &quot;Security&quot;</span>
<span class="sd">    AND event_id = 4662</span>
<span class="sd">    AND AccessMask = &quot;0x2&quot;</span>
<span class="sd">    AND lower(ObjectName) LIKE &quot;%bckupkey%&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Analytic-II">Analytic II<a class="anchor-link" href="#Analytic-II"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left">FP Rate</th>
<th style="text-align:left">Log Channel</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Low</td>
<td style="text-align:left">['Security']</td>
<td style="text-align:left">We can get the user logon id of the user that accessed the <em>bckupkey</em> object and JOIN it with a successful logon event (4624) user logon id to find the source IP</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT o.`@timestamp`, o.computer_name, o.ObjectName, a.IpAddress</span>
<span class="sd">FROM mordorTable o</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT computer_name,TargetUserName,TargetLogonId,IpAddress</span>
<span class="sd">    FROM mordorTable</span>
<span class="sd">    WHERE channel = &quot;Security&quot;</span>
<span class="sd">        AND LogonType = 3</span>
<span class="sd">        AND IpAddress is not null</span>
<span class="sd">        AND NOT TargetUserName LIKE &quot;%$&quot;</span>
<span class="sd">    ) a</span>
<span class="sd">ON o.SubjectLogonId = a.TargetLogonId</span>
<span class="sd">WHERE channel = &quot;Security&quot;</span>
<span class="sd">    AND o.event_id = 4662</span>
<span class="sd">    AND o.AccessMask = &quot;0x2&quot;</span>
<span class="sd">    AND lower(o.ObjectName) LIKE &quot;%bckupkey%&quot;</span>
<span class="sd">    AND o.computer_name = a.computer_name</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Analytic-III">Analytic III<a class="anchor-link" href="#Analytic-III"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left">FP Rate</th>
<th style="text-align:left">Log Channel</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Low</td>
<td style="text-align:left">['Security']</td>
<td style="text-align:left">Monitoring for access to the protected_storage service is very interesting to document potential DPAPI activity over the network</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT `@timestamp`, computer_name, SubjectUserName, ShareName, RelativeTargetName, AccessMask, IpAddress</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">WHERE channel = &quot;Security&quot;</span>
<span class="sd">    AND event_id = 5145</span>
<span class="sd">    AND ShareName LIKE &quot;%IPC%&quot;</span>
<span class="sd">    AND RelativeTargetName = &quot;protected_storage&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Analytic-IV">Analytic IV<a class="anchor-link" href="#Analytic-IV"> </a></h3>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th style="text-align:left">FP Rate</th>
<th style="text-align:left">Log Channel</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Low</td>
<td style="text-align:left">['Security']</td>
<td style="text-align:left">This event generates every time that a backup is attempted for the DPAPI Master Key. When a computer is a member of a domain, DPAPI has a backup mechanism to allow unprotection of the data. When a Master Key is generated, DPAPI communicates with a domain controller.</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT `@timestamp`, computer_name, SubjectUserName, MasterKeyId, RecoveryKeyId</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">WHERE channel = &quot;Security&quot;</span>
<span class="sd">    AND event_id = 4692</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Detection-Blindspots">Detection Blindspots<a class="anchor-link" href="#Detection-Blindspots"> </a></h2>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hunter-Notes">Hunter Notes<a class="anchor-link" href="#Hunter-Notes"> </a></h2><ul>
<li>Backup key can be displayed as base64 blob or exported as a .pvk file on disk (Mimikatz-like)</li>
<li>Windows security event 4692 (Backup of data protection master key was attempted) also generates every time a new DPAPI Master Key is generated</li>
<li>When a computer is a member of a domain, DPAPI has a backup mechanism to allow unprotection of the data. When a Master Key is generated, DPAPI communicates with a domain controller.</li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hunt-Output">Hunt Output<a class="anchor-link" href="#Hunt-Output"> </a></h2><table>
<thead><tr>
<th style="text-align:left">Category</th>
<th style="text-align:left">Type</th>
<th style="text-align:left">Name</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">signature</td>
<td style="text-align:left">SIGMA</td>
<td style="text-align:left"><a href="https://github.com/hunters-forge/ThreatHunter-Playbook/tree/master/signatures/sigma/win_dpapi_domain_backupkey_extraction.yml">win_dpapi_domain_backupkey_extraction</a></td>
</tr>
<tr>
<td style="text-align:left">signature</td>
<td style="text-align:left">SIGMA</td>
<td style="text-align:left"><a href="https://github.com/hunters-forge/ThreatHunter-Playbook/tree/master/signatures/sigma/win_protected_storage_service_access.yml">win_protected_storage_service_access</a></td>
</tr>
<tr>
<td style="text-align:left">signature</td>
<td style="text-align:left">SIGMA</td>
<td style="text-align:left"><a href="https://github.com/hunters-forge/ThreatHunter-Playbook/tree/master/signatures/sigma/win_dpapi_domain_masterkey_backup_attempt.yml">win_dpapi_domain_masterkey_backup_attempt</a></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">References<a class="anchor-link" href="#References"> </a></h2><ul>
<li><a href="https://www.harmj0y.net/blog/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/">https://www.harmj0y.net/blog/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/</a></li>
<li><a href="https://digital-forensics.sans.org/summit-archives/dfirprague14/Give_Me_the_Password_and_Ill_Rule_the_World_Francesco_Picasso.pdf">https://digital-forensics.sans.org/summit-archives/dfirprague14/Give_Me_the_Password_and_Ill_Rule_the_World_Francesco_Picasso.pdf</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/devnotes/pstore">https://docs.microsoft.com/en-us/windows/desktop/devnotes/pstore</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz/blob/641a3b29acd326d07269300d94dceafea041f760/mimikatz/modules/kuhl_m_lsadump.c#L1907">https://github.com/gentilkiwi/mimikatz/blob/641a3b29acd326d07269300d94dceafea041f760/mimikatz/modules/kuhl_m_lsadump.c#L1907</a></li>
<li><a href="https://github.com/GhostPack/SharpDPAPI/blob/6388040a92e59fc0d5a82b4ec31599aa6778fd3b/SharpDPAPI/lib/Backup.cs#L43">https://github.com/GhostPack/SharpDPAPI/blob/6388040a92e59fc0d5a82b4ec31599aa6778fd3b/SharpDPAPI/lib/Backup.cs#L43</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz/blob/641a3b29acd326d07269300d94dceafea041f760/mimikatz/modules/kuhl_m_lsadump.c#L1906-L1926">https://github.com/gentilkiwi/mimikatz/blob/641a3b29acd326d07269300d94dceafea041f760/mimikatz/modules/kuhl_m_lsadump.c#L1906-L1926</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz/blob/641a3b29acd326d07269300d94dceafea041f760/mimikatz/modules/kuhl_m_lsadump.c#L1758">https://github.com/gentilkiwi/mimikatz/blob/641a3b29acd326d07269300d94dceafea041f760/mimikatz/modules/kuhl_m_lsadump.c#L1758</a></li>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/88c6bd18-6c40-4a82-ae19-fe7bfec5108b">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/88c6bd18-6c40-4a82-ae19-fe7bfec5108b</a></li>
</ul>

</div>
</div>
</div>
</div>

 


    </main>
    