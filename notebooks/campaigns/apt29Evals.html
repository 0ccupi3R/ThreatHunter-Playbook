

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Free Telemetry Notebook &#8212; Threat Hunter Playbook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/sphinx-book-theme.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/mystnb.js"></script>
    <script src="../../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .secondtoggle, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script async="async" src="../../_static/thebelab.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="canonical" href="https://threathunterplaybook.com/notebooks/campaigns/apt29Evals.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Windows" href="../windows/windows.html" />
    <link rel="prev" title="Free Telemetry Report" href="../../evals/apt29/report.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
<!-- Put requirejs at the end so it's always after bootstrap -->
<!-- TODO: remove this once https://github.com/pandas-dev/pydata-sphinx-theme/pull/149 is merged -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>


<!-- Opengraph tags -->
<meta property="og:url"         content="https://threathunterplaybook.com/notebooks/campaigns/apt29Evals.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Free Telemetry Notebook" />
<meta property="og:description" content="Free Telemetry Notebook          Group  APT29  Description  APT29 is a threat group that has been attributed to the Russian government and has operated since at" />
<meta property="og:image"       content="https://threathunterplaybook.com/_static/logo.png" />

<meta name="twitter:card" content="summary">


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          

<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Threat Hunter Playbook</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  
  <ul class="nav sidenav_l1">
<li class="navbar-special">
<p class="margin-caption">Pre-Hunt Activities</p>
</li>
  <li class="">
    <a href="../../pre-hunt/data_management.html">Data Management</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">Campaign Notebooks</p>
</li>
  <li class="active">
    <a href="../../evals/intro.html">ATT&CK Evaluations</a>
  <ul class="nav sidenav_l2">
    <li class="active">
      <a href="../../evals/apt29/intro.html">APT 29</a>
      <ul class="nav sidenav_l3">
      <li class="">
        <a href="../../evals/apt29/report.html">Free Telemetry Report</a>
      </li>
      <li class="active">
        <a href="">Free Telemetry Notebook</a>
      </li>
    </ul>
    </li>
  </ul>
  </li>
<li class="navbar-special">
<p class="margin-caption">Targeted Notebooks</p>
</li>
  <li class="">
    <a href="../windows/windows.html">Windows</a>
  </li>
  <li class="">
    <a href="../linux/linux.html">Linux</a>
  </li>
  <li class="">
    <a href="../mac/mac.html">Mac</a>
  </li>
<li class="navbar-special">
<p class="margin-caption">Tutorials</p>
</li>
  <li class="">
    <a href="../../tutorials/jupyter/introduction.html">Jupyter Notebooks</a>
  </li>
</ul>
</nav>
<p class="navbar_footer">Powered by <a href="https://jupyterbook.org">Jupyter Book</a></p>
</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse" data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu" aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation" title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i class="fas fa-download"></i></button>

            
            <div class="dropdown-buttons">
                <!-- ipynb file if we had a myst markdown file -->
                
                <!-- Download raw file -->
                <a class="dropdown-buttons" href="../../_sources/notebooks/campaigns/apt29Evals.ipynb.txt"><button type="button" class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip" data-placement="left">.ipynb</button></a>
                <!-- Download PDF via print -->
                <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF" onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
            </div>
            
        </div>

        <!-- Edit this page -->
        <a class="edit-button" href="https://github.com/hunters-forge/ThreatHunter-Playbook/edit/master/docs/notebooks/campaigns/apt29Evals.ipynb"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="bottom" title="Edit this page"><i class="fas fa-pencil-alt"></i></button></a>

        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
            <div class="dropdown-buttons">
                
                <a class="binder-button" href="https://mybinder.org/v2/gh/hunters-forge/ThreatHunter-Playbook/master?urlpath=tree/docs/notebooks/campaigns/apt29Evals.ipynb"><button type="button" class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip" data-placement="left"><img class="binder-button-logo" src="../../_static/images/logo_binder.svg" alt="Interact on binder">Binder</button></a>
                
                
                <button type="button" class="btn btn-secondary topbarbtn thebelab-launch-button" onclick="initThebelab()" title="Launch Thebelab" data-toggle="tooltip" data-placement="left"><i class="fas fa-rocket"></i><span style="margin-left: .4em;">ThebeLab</span></button>
                
            </div>
        </div>
        

        
    </div>
    <div class="d-none d-md-block col-md-2 bd-toc show">
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#telemetry-detection-category" class="nav-link">Telemetry Detection Category</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#import-libraries" class="nav-link">Import Libraries</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#start-spark-session" class="nav-link">Start Spark Session</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#decompress-dataset" class="nav-link">Decompress Dataset</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#import-datasets" class="nav-link">Import Datasets</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#create-temporary-sql-view" class="nav-link">Create Temporary SQL View</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#adversary-detection-steps" class="nav-link">Adversary - Detection Steps</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-user-execution" class="nav-link">1.A.1. User Execution</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#detection-type-telemetry-none" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#detection-type-general-none" class="nav-link">Detection Type:General(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-masquerading" class="nav-link">1.A.2. Masquerading</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id1" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-3-uncommonly-used-port" class="nav-link">1.A.3. Uncommonly Used Port</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id2" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-4-standard-cryptographic-protocol" class="nav-link">1.A.4. Standard Cryptographic Protocol</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#detection-type-none-none" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-command-line-interface" class="nav-link">1.B.1. Command-Line Interface</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#detection-type-telemetry-correlated" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-2-powershell" class="nav-link">1.B.2. PowerShell</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id3" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-file-and-directory-discovery" class="nav-link">2.A.1. File and Directory Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id4" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-automated-collection" class="nav-link">2.A.2. Automated Collection</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id5" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-3-data-from-local-system" class="nav-link">2.A.3. Data from Local System</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id6" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-4-data-compressed" class="nav-link">2.A.4. Data Compressed</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id7" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-5-data-staged" class="nav-link">2.A.5. Data Staged</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id8" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-exfiltration-over-command-and-control-channel" class="nav-link">2.B.1. Exfiltration Over Command and Control Channel</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id9" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-remote-file-copy" class="nav-link">3.A.1. Remote File Copy</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id10" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-obfuscated-files-or-information" class="nav-link">3.A.2. Obfuscated Files or Information</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id11" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-component-object-model-hijacking" class="nav-link">3.B.1. Component Object Model Hijacking</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id12" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-2-bypass-user-account-control" class="nav-link">3.B.2. Bypass User Account Control</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id13" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-3-commonly-used-port" class="nav-link">3.B.3. Commonly Used Port</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id14" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-4-standard-application-layer-protocol" class="nav-link">3.B.4. Standard Application Layer Protocol</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id15" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-5-standard-cryptographic-protocol" class="nav-link">3.B.5. Standard Cryptographic Protocol</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id16" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-1-modify-registry" class="nav-link">3.C.1. Modify Registry</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id17" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#id18" class="nav-link">4.A.1. Remote File Copy</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id19" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-powershell" class="nav-link">4.A.2. PowerShell</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id20" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-3-deobfuscate-decode-files-or-information" class="nav-link">4.A.3. Deobfuscate/Decode Files or Information</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id21" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-process-discovery" class="nav-link">4.B.1. Process Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id22" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-2-file-deletion" class="nav-link">4.B.2. File Deletion</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id23" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-3-file-deletion" class="nav-link">4.B.3. File Deletion</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id24" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-4-file-deletion" class="nav-link">4.B.4. File Deletion</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id25" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-1-file-and-directory-discovery" class="nav-link">4.C.1. File and Directory Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id26" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-2-system-owner-user-discovery" class="nav-link">4.C.2. System Owner/User Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id27" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-3-system-information-discovery" class="nav-link">4.C.3. System Information Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id28" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-4-system-network-configuration-discovery" class="nav-link">4.C.4. System Network Configuration Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id29" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-5-process-discovery" class="nav-link">4.C.5. Process Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id30" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-6-system-information-discovery" class="nav-link">4.C.6. System Information Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id31" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-7-security-software-discovery" class="nav-link">4.C.7. Security Software Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id32" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-8-security-software-discovery" class="nav-link">4.C.8. Security Software Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id33" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-9-permission-groups-discovery" class="nav-link">4.C.9. Permission Groups Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#detection-type-technique-alert" class="nav-link">Detection Type:technique(alert)</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#id34" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-10-execution-through-api" class="nav-link">4.C.10. Execution through API</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id35" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-11-permission-groups-discovery" class="nav-link">4.C.11. Permission Groups Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id36" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-12-execution-through-api" class="nav-link">4.C.12. Execution through API</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id37" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-new-service" class="nav-link">5.A.1. New Service</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id38" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-registry-run-keys-startup-folder" class="nav-link">5.B.1. Registry Run Keys / Startup Folder</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id39" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-credentials-in-files" class="nav-link">6.A.1. Credentials in Files</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id40" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-credential-dumping" class="nav-link">6.A.2. Credential Dumping</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id41" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-3-masquerading" class="nav-link">6.A.3. Masquerading</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id42" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#detection-type-general-correlated" class="nav-link">Detection Type:General(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-private-keys" class="nav-link">6.B.1. Private Keys</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id43" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-1-credential-dumping" class="nav-link">6.C.1. Credential Dumping</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id44" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-screen-capture" class="nav-link">7.A.1. Screen Capture</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id45" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#id46" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-clipboard-data" class="nav-link">7.A.2. Clipboard Data</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id47" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-3-input-capture" class="nav-link">7.A.3. Input Capture</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id48" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-data-from-local-system" class="nav-link">7.B.1. Data from Local System</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id49" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-2-data-compressed" class="nav-link">7.B.2. Data Compressed</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id50" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-3-data-encrypted" class="nav-link">7.B.3. Data Encrypted</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id51" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-4-exfiltration-over-alternative-protocol" class="nav-link">7.B.4. Exfiltration Over Alternative Protocol</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id52" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#id53" class="nav-link">Detection Type:technique(Alert)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-remote-system-discovery" class="nav-link">8.A.1. Remote System Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id54" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-remote-system-discovery" class="nav-link">8.A.2. Remote System Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id55" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-3-process-discovery" class="nav-link">8.A.3. Process Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id56" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-remote-file-copy" class="nav-link">8.B.1. Remote File Copy</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id57" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-2-software-packing" class="nav-link">8.B.2. Software Packing</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id58" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-1-valid-accounts" class="nav-link">8.C.1. Valid Accounts</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id59" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-2-windows-admin-shares" class="nav-link">8.C.2. Windows Admin Shares</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id60" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-3-service-execution" class="nav-link">8.C.3. Service Execution</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id61" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#id62" class="nav-link">9.A.1. Remote File Copy</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id63" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-2-remote-file-copy" class="nav-link">9.A.2. Remote File Copy</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id64" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-1-powershell" class="nav-link">9.B.1. PowerShell</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id65" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-2-file-and-directory-discovery" class="nav-link">9.B.2. File and Directory Discovery</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id66" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-3-automated-collection" class="nav-link">9.B.3. Automated Collection</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id67" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-4-data-from-local-system" class="nav-link">9.B.4. Data from Local System</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id68" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-5-data-staged" class="nav-link">9.B.5. Data Staged</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id69" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-6-data-encrypted" class="nav-link">9.B.6. Data Encrypted</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id70" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-7-data-compressed" class="nav-link">9.B.7. Data Compressed</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id71" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-8-exfiltration-over-command-and-control-channel" class="nav-link">9.B.8. Exfiltration Over Command and Control Channel</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id72" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-1-file-deletion" class="nav-link">9.C.1. File Deletion</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id73" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-2-file-deletion" class="nav-link">9.C.2. File Deletion</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id74" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-3-file-deletion" class="nav-link">9.C.3. File Deletion</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id75" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#c-4-file-deletion" class="nav-link">9.C.4. File Deletion</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id76" class="nav-link">Detection Type:Telemetry(Correlated)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#a-1-service-execution" class="nav-link">10.A.1. Service Execution</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id77" class="nav-link">Detection Type:Telemetry(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#id78" class="nav-link">10.B.1. Registry Run Keys / Startup Folder</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id79" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-2-execution-through-api" class="nav-link">10.B.2. Execution through API</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id80" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#b-3-access-token-manipulation" class="nav-link">10.B.3. Access Token Manipulation</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#id81" class="nav-link">Detection Type:None(None)</a>
        </li>
    
            </ul>
        </li>
    
    </ul>
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/hunters-forge/ThreatHunter-Playbook/edit/master/docs/notebooks/campaigns/apt29Evals.ipynb">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 col-xxl-7 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="free-telemetry-notebook">
<h1>Free Telemetry Notebook<a class="headerlink" href="#free-telemetry-notebook" title="Permalink to this headline">¶</a></h1>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:left head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Group</p></td>
<td class="text-align:left"><p>APT29</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Description</p></td>
<td class="text-align:left"><p>APT29 is a threat group that has been attributed to the Russian government and has operated since at least 2008. This group reportedly compromised the Democratic National Committee starting in the summer of 2015</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Author</p></td>
<td class="text-align:left"><p><a class="reference external" href="https://github.com/OTRF/detection-hackathon-apt29">Open Threat Research - APT29 Detection Hackathon</a></p></td>
</tr>
</tbody>
</table>
<div class="section" id="telemetry-detection-category">
<h2>Telemetry Detection Category<a class="headerlink" href="#telemetry-detection-category" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing Libraries</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">LabelSet</span><span class="p">,</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">bokeh.transform</span> <span class="kn">import</span> <span class="n">dodge</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># You need to run this code at the beginning in order to show visualization using Jupyter Notebooks</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span>
<span class="n">output_notebook</span><span class="p">()</span>
<span class="n">apt29</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/hunters-forge/ThreatHunter-Playbook/master/docs/evals/apt29/data/otr_results.json&#39;</span><span class="p">)</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">apt29</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="s1">&#39;stepname&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;vendor&quot;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">apt29</span><span class="p">[</span><span class="n">apt29</span><span class="p">[</span><span class="s1">&#39;detectiontype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Telemetry&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="s1">&#39;stepname&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">telemetry</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;vendor&quot;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">summary</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;telemetry&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0%}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="c1"># Get Total Average Telemetry coverage</span>
<span class="n">total_avg_percentage</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;telemetry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

<span class="c1"># Lists of values to create ColumnDataSource</span>
<span class="n">stepname</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;stepname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">telemetry</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;telemetry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">percentage</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Creating ColumnDataSource object: source of data for visualization</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;stepname&#39;</span><span class="p">:</span><span class="n">stepname</span><span class="p">,</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">:</span><span class="n">total</span><span class="p">,</span><span class="s1">&#39;covered&#39;</span><span class="p">:</span><span class="n">telemetry</span><span class="p">,</span><span class="s1">&#39;percentage&#39;</span><span class="p">:</span><span class="n">percentage</span><span class="p">})</span>

<span class="c1"># Defining HoverTool object (Display info with Mouse): It is applied to chart named &#39;needHover&#39;</span>
<span class="n">hover_tool</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;needHover&#39;</span><span class="p">],</span><span class="n">tooltips</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Covered&quot;</span><span class="p">,</span> <span class="s2">&quot;@covered&quot;</span><span class="p">),(</span><span class="s2">&quot;Percentage&quot;</span><span class="p">,</span> <span class="s2">&quot;@percentage&quot;</span><span class="p">)])</span>

<span class="c1"># Creating Figure</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">x_range</span><span class="o">=</span><span class="n">stepname</span><span class="p">,</span><span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">plot_height</span><span class="o">=</span><span class="mi">550</span><span class="p">,</span><span class="n">plot_width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span><span class="n">toolbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover_tool</span><span class="p">])</span>

<span class="c1"># Creating Vertical Bar Charts</span>
<span class="n">p</span><span class="o">.</span><span class="n">vbar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dodge</span><span class="p">(</span><span class="s1">&#39;stepname&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">x_range</span><span class="p">),</span><span class="n">top</span><span class="o">=</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#c9d9d3&quot;</span><span class="p">,</span><span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">vbar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dodge</span><span class="p">(</span><span class="s1">&#39;stepname&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">x_range</span><span class="p">),</span><span class="n">top</span><span class="o">=</span><span class="s1">&#39;covered&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#718dbf&quot;</span><span class="p">,</span><span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Covered&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;needHover&#39;</span><span class="p">)</span>

<span class="c1"># Adding Legend</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;top_right&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">border_line_width</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">border_line_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">border_line_alpha</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="c1"># Adding Title</span>
<span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Telemetry Detection Category (Average Coverage: </span><span class="si">{}</span><span class="s1">%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_avg_percentage</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text_font_size</span> <span class="o">=</span> <span class="s1">&#39;12pt&#39;</span>

<span class="c1"># Adding Axis Labels</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Emulation Steps&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">major_label_orientation</span> <span class="o">=</span> <span class="mi">45</span>

<span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Count of Sub-Steps&#39;</span>

<span class="c1"># Adding Data Label: Only for total of sub-steps</span>
<span class="n">total_label</span> <span class="o">=</span> <span class="n">LabelSet</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;stepname&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">,</span><span class="n">text_align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;glyph&#39;</span><span class="p">,</span><span class="n">source</span><span class="o">=</span> <span class="n">source</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">total_label</span><span class="p">)</span>

<span class="c1">#Showing visualization</span>
<span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<div class="bk-root">
    <a href="https://bokeh.org" target="_blank" class="bk-logo bk-logo-small bk-logo-notebook"></a>
    <span id="1001">Loading BokehJS ...</span>
</div></div><script type="application/javascript">
(function(root) {
  function now() {
    return new Date();
  }

  var force = true;

  if (typeof root._bokeh_onload_callbacks === "undefined" || force === true) {
    root._bokeh_onload_callbacks = [];
    root._bokeh_is_loading = undefined;
  }

  var JS_MIME_TYPE = 'application/javascript';
  var HTML_MIME_TYPE = 'text/html';
  var EXEC_MIME_TYPE = 'application/vnd.bokehjs_exec.v0+json';
  var CLASS_NAME = 'output_bokeh rendered_html';

  /**
   * Render data to the DOM node
   */
  function render(props, node) {
    var script = document.createElement("script");
    node.appendChild(script);
  }

  /**
   * Handle when an output is cleared or removed
   */
  function handleClearOutput(event, handle) {
    var cell = handle.cell;

    var id = cell.output_area._bokeh_element_id;
    var server_id = cell.output_area._bokeh_server_id;
    // Clean up Bokeh references
    if (id != null && id in Bokeh.index) {
      Bokeh.index[id].model.document.clear();
      delete Bokeh.index[id];
    }

    if (server_id !== undefined) {
      // Clean up Bokeh references
      var cmd = "from bokeh.io.state import curstate; print(curstate().uuid_to_server['" + server_id + "'].get_sessions()[0].document.roots[0]._id)";
      cell.notebook.kernel.execute(cmd, {
        iopub: {
          output: function(msg) {
            var id = msg.content.text.trim();
            if (id in Bokeh.index) {
              Bokeh.index[id].model.document.clear();
              delete Bokeh.index[id];
            }
          }
        }
      });
      // Destroy server and session
      var cmd = "import bokeh.io.notebook as ion; ion.destroy_server('" + server_id + "')";
      cell.notebook.kernel.execute(cmd);
    }
  }

  /**
   * Handle when a new output is added
   */
  function handleAddOutput(event, handle) {
    var output_area = handle.output_area;
    var output = handle.output;

    // limit handleAddOutput to display_data with EXEC_MIME_TYPE content only
    if ((output.output_type != "display_data") || (!output.data.hasOwnProperty(EXEC_MIME_TYPE))) {
      return
    }

    var toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);

    if (output.metadata[EXEC_MIME_TYPE]["id"] !== undefined) {
      toinsert[toinsert.length - 1].firstChild.textContent = output.data[JS_MIME_TYPE];
      // store reference to embed id on output_area
      output_area._bokeh_element_id = output.metadata[EXEC_MIME_TYPE]["id"];
    }
    if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
      var bk_div = document.createElement("div");
      bk_div.innerHTML = output.data[HTML_MIME_TYPE];
      var script_attrs = bk_div.children[0].attributes;
      for (var i = 0; i < script_attrs.length; i++) {
        toinsert[toinsert.length - 1].firstChild.setAttribute(script_attrs[i].name, script_attrs[i].value);
        toinsert[toinsert.length - 1].firstChild.textContent = bk_div.children[0].textContent
      }
      // store reference to server id on output_area
      output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
    }
  }

  function register_renderer(events, OutputArea) {

    function append_mime(data, metadata, element) {
      // create a DOM node to render to
      var toinsert = this.create_output_subarea(
        metadata,
        CLASS_NAME,
        EXEC_MIME_TYPE
      );
      this.keyboard_manager.register_events(toinsert);
      // Render to node
      var props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
      render(props, toinsert[toinsert.length - 1]);
      element.append(toinsert);
      return toinsert
    }

    /* Handle when an output is cleared or removed */
    events.on('clear_output.CodeCell', handleClearOutput);
    events.on('delete.Cell', handleClearOutput);

    /* Handle when a new output is added */
    events.on('output_added.OutputArea', handleAddOutput);

    /**
     * Register the mime type and append_mime function with output_area
     */
    OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
      /* Is output safe? */
      safe: true,
      /* Index of renderer in `output_area.display_order` */
      index: 0
    });
  }

  // register the mime type if in Jupyter Notebook environment and previously unregistered
  if (root.Jupyter !== undefined) {
    var events = require('base/js/events');
    var OutputArea = require('notebook/js/outputarea').OutputArea;

    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  }

  
  if (typeof (root._bokeh_timeout) === "undefined" || force === true) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  var NB_LOAD_WARNING = {'data': {'text/html':
     "<div style='background-color: #fdd'>\n"+
     "<p>\n"+
     "BokehJS does not appear to have successfully loaded. If loading BokehJS from CDN, this \n"+
     "may be due to a slow or bad network connection. Possible fixes:\n"+
     "</p>\n"+
     "<ul>\n"+
     "<li>re-rerun `output_notebook()` to attempt to load from CDN again, or</li>\n"+
     "<li>use INLINE resources instead, as so:</li>\n"+
     "</ul>\n"+
     "<code>\n"+
     "from bokeh.resources import INLINE\n"+
     "output_notebook(resources=INLINE)\n"+
     "</code>\n"+
     "</div>"}};

  function display_loaded() {
    var el = document.getElementById("1001");
    if (el != null) {
      el.textContent = "BokehJS is loading...";
    }
    if (root.Bokeh !== undefined) {
      if (el != null) {
        el.textContent = "BokehJS " + root.Bokeh.version + " successfully loaded.";
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(display_loaded, 100)
    }
  }


  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];

    root._bokeh_onload_callbacks.push(callback);
    if (root._bokeh_is_loading > 0) {
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    }
    if (js_urls == null || js_urls.length === 0) {
      run_callbacks();
      return null;
    }
    console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
    root._bokeh_is_loading = css_urls.length + js_urls.length;

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }

    function on_error() {
      console.error("failed to load " + url);
    }

    for (var i = 0; i < css_urls.length; i++) {
      var url = css_urls[i];
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error;
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }

    const hashes = {"https://cdn.bokeh.org/bokeh/release/bokeh-2.0.2.min.js": "ufR9RFnRs6lniiaFvtJziE0YeidtAgBRH6ux2oUItHw5WTvE1zuk9uzhUU/FJXDp", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.0.2.min.js": "8QM/PGWBT+IssZuRcDcjzwIh1mkOmJSoNMmyYDZbCfXJg3Ap1lEvdVgFuSAwhb/J", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.0.2.min.js": "Jm8cH3Rg0P6UeZhVY5cLy1WzKajUT9KImCY+76hEqrcJt59/d8GPvFHjCkYgnSIn", "https://cdn.bokeh.org/bokeh/release/bokeh-gl-2.0.2.min.js": "Ozhzj+SI7ywm74aOI/UajcWz+C0NjsPunEVyVIrxzYkB+jA+2tUw8x5xJCbVtK5I"};

    for (var i = 0; i < js_urls.length; i++) {
      var url = js_urls[i];
      var element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      if (url in hashes) {
        element.crossOrigin = "anonymous";
        element.integrity = "sha384-" + hashes[url];
      }
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  
  var js_urls = ["https://cdn.bokeh.org/bokeh/release/bokeh-2.0.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.0.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.0.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-gl-2.0.2.min.js"];
  var css_urls = [];
  

  var inline_js = [
    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
    function(Bokeh) {
    
    
    }
  ];

  function run_inline_js() {
    
    if (root.Bokeh !== undefined || force === true) {
      
    for (var i = 0; i < inline_js.length; i++) {
      inline_js[i].call(root, root.Bokeh);
    }
    if (force === true) {
        display_loaded();
      }} else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    } else if (force !== true) {
      var cell = $(document.getElementById("1001")).parents('.cell').data().cell;
      cell.output_area.append_execute_result(NB_LOAD_WARNING)
    }

  }

  if (root._bokeh_is_loading === 0) {
    console.debug("Bokeh: BokehJS loaded, going straight to plotting");
    run_inline_js();
  } else {
    load_libs(css_urls, js_urls, function() {
      console.debug("Bokeh: BokehJS plotting callback run at", now());
      run_inline_js();
    });
  }
}(window));</script><div class="output text_html">





<div class="bk-root" id="b518b8c8-f1d4-431d-8385-cd6aec8babfa" data-root-id="1004"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
    
  var docs_json = {"53ad707f-7b2a-4f8e-b77d-6dca58230b4a":{"roots":{"references":[{"attributes":{"below":[{"id":"1013"}],"center":[{"id":"1015"},{"id":"1019"},{"id":"1034"},{"id":"1054"}],"left":[{"id":"1016"}],"plot_height":550,"renderers":[{"id":"1026"},{"id":"1040"}],"title":{"id":"1029"},"toolbar":{"id":"1020"},"x_range":{"id":"1005"},"x_scale":{"id":"1009"},"y_range":{"id":"1007"},"y_scale":{"id":"1011"}},"id":"1004","subtype":"Figure","type":"Plot"},{"attributes":{},"id":"1011","type":"LinearScale"},{"attributes":{"align":"center","text":"Telemetry Detection Category (Average Coverage: 77%)","text_font_size":{"value":"12pt"}},"id":"1029","type":"Title"},{"attributes":{"factors":["1:Initial Compromise","2:Collection & Exfiltration","3:Deploy Stealth Toolkit","4:Clean Up","5:Establish Persistence","6:Credential Access","7:Collection & Exfiltration","8:Expand Access","9:Clean Up, Collection and Exfiltration","10:Persistence Execution"]},"id":"1005","type":"FactorRange"},{"attributes":{},"id":"1017","type":"BasicTicker"},{"attributes":{"data_source":{"id":"1002"},"glyph":{"id":"1024"},"hover_glyph":null,"muted_glyph":null,"nonselection_glyph":{"id":"1025"},"selection_glyph":null,"view":{"id":"1027"}},"id":"1026","type":"GlyphRenderer"},{"attributes":{"fill_color":{"value":"#718dbf"},"line_color":{"value":"#718dbf"},"top":{"field":"covered"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1036"}}},"id":"1038","type":"VBar"},{"attributes":{},"id":"1009","type":"CategoricalScale"},{"attributes":{"label":{"value":"Covered"},"renderers":[{"id":"1040"}]},"id":"1050","type":"LegendItem"},{"attributes":{},"id":"1048","type":"Selection"},{"attributes":{},"id":"1032","type":"CategoricalTickFormatter"},{"attributes":{"range":{"id":"1005"}},"id":"1036","type":"Dodge"},{"attributes":{"source":{"id":"1002"}},"id":"1027","type":"CDSView"},{"attributes":{"axis":{"id":"1013"},"ticker":null},"id":"1015","type":"Grid"},{"attributes":{"fill_alpha":{"value":0.1},"fill_color":{"value":"#c9d9d3"},"line_alpha":{"value":0.1},"line_color":{"value":"#c9d9d3"},"top":{"field":"sub-Steps"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1022"}}},"id":"1025","type":"VBar"},{"attributes":{"level":"glyph","source":{"id":"1002"},"text":{"field":"sub-Steps"},"text_align":"center","x":{"field":"stepname"},"y":{"field":"sub-Steps"}},"id":"1054","type":"LabelSet"},{"attributes":{"fill_alpha":{"value":0.1},"fill_color":{"value":"#718dbf"},"line_alpha":{"value":0.1},"line_color":{"value":"#718dbf"},"top":{"field":"covered"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1036"}}},"id":"1039","type":"VBar"},{"attributes":{},"id":"1014","type":"CategoricalTicker"},{"attributes":{"axis_label":"Count of Sub-Steps","formatter":{"id":"1030"},"ticker":{"id":"1017"}},"id":"1016","type":"LinearAxis"},{"attributes":{"data_source":{"id":"1002"},"glyph":{"id":"1038"},"hover_glyph":null,"muted_glyph":null,"name":"needHover","nonselection_glyph":{"id":"1039"},"selection_glyph":null,"view":{"id":"1041"}},"id":"1040","type":"GlyphRenderer"},{"attributes":{"range":{"id":"1005"}},"id":"1022","type":"Dodge"},{"attributes":{"axis_label":"Emulation Steps","formatter":{"id":"1032"},"major_label_orientation":45,"ticker":{"id":"1014"}},"id":"1013","type":"CategoricalAxis"},{"attributes":{"source":{"id":"1002"}},"id":"1041","type":"CDSView"},{"attributes":{},"id":"1049","type":"UnionRenderers"},{"attributes":{"end":23},"id":"1007","type":"Range1d"},{"attributes":{"axis":{"id":"1016"},"dimension":1,"ticker":null},"id":"1019","type":"Grid"},{"attributes":{"callback":null,"names":["needHover"],"tooltips":[["Covered","@covered"],["Percentage","@percentage"]]},"id":"1003","type":"HoverTool"},{"attributes":{"data":{"covered":[5,4,6,19,2,3,6,7,12,1],"percentage":["71%","67%","75%","95%","100%","50%","67%","88%","86%","25%"],"stepname":["1:Initial Compromise","2:Collection & Exfiltration","3:Deploy Stealth Toolkit","4:Clean Up","5:Establish Persistence","6:Credential Access","7:Collection & Exfiltration","8:Expand Access","9:Clean Up, Collection and Exfiltration","10:Persistence Execution"],"sub-Steps":[7,6,8,20,2,6,9,8,14,4]},"selected":{"id":"1048"},"selection_policy":{"id":"1049"}},"id":"1002","type":"ColumnDataSource"},{"attributes":{"label":{"value":"Total"},"renderers":[{"id":"1026"}]},"id":"1035","type":"LegendItem"},{"attributes":{"active_drag":"auto","active_inspect":"auto","active_multi":null,"active_scroll":"auto","active_tap":"auto","tools":[{"id":"1003"}]},"id":"1020","type":"Toolbar"},{"attributes":{},"id":"1030","type":"BasicTickFormatter"},{"attributes":{"border_line_alpha":0.3,"border_line_color":"black","border_line_width":3,"items":[{"id":"1035"},{"id":"1050"}]},"id":"1034","type":"Legend"},{"attributes":{"fill_color":{"value":"#c9d9d3"},"line_color":{"value":"#c9d9d3"},"top":{"field":"sub-Steps"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1022"}}},"id":"1024","type":"VBar"}],"root_ids":["1004"]},"title":"Bokeh Application","version":"2.0.2"}};
  var render_items = [{"docid":"53ad707f-7b2a-4f8e-b77d-6dca58230b4a","root_ids":["1004"],"roots":{"1004":"b518b8c8-f1d4-431d-8385-cd6aec8babfa"}}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);

  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
</div>
<div class="section" id="import-libraries">
<h2>Import Libraries<a class="headerlink" href="#import-libraries" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="start-spark-session">
<h2>Start Spark Session<a class="headerlink" href="#start-spark-session" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.caseSensitive&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="decompress-dataset">
<h2>Decompress Dataset<a class="headerlink" href="#decompress-dataset" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!wget https://github.com/hunters-forge/mordor/raw/master/datasets/large/apt29/day1/apt29_evals_day1_manual.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!unzip apt29_evals_day1_manual.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="import-datasets">
<h2>Import Datasets<a class="headerlink" href="#import-datasets" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_day1_host</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="s1">&#39;apt29_evals_day1_manual_2020-05-01225525.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-temporary-sql-view">
<h2>Create Temporary SQL View<a class="headerlink" href="#create-temporary-sql-view" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_day1_host</span><span class="o">.</span><span class="n">createTempView</span><span class="p">(</span><span class="s1">&#39;apt29Host&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="adversary-detection-steps">
<h2>Adversary - Detection Steps<a class="headerlink" href="#adversary-detection-steps" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="a-1-user-execution">
<h2>1.A.1. User Execution<a class="headerlink" href="#a-1-user-execution" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> User Pam executed payload rcs.3aka3.doc</p>
<p><strong>Criteria:</strong> The rcs.3aka3.doc process spawning from explorer.exe</p>
<div class="section" id="detection-type-telemetry-none">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#detection-type-telemetry-none" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:204B00B6-A92B-4EF7-8510-4FB237703147</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(ParentImage) LIKE &quot;%explorer.exe&quot;</span>
<span class="sd">    AND LOWER(Image) LIKE &quot;%3aka3%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:52540C1E-DD76-41B2-93ED-CFBA2B94ECF7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND LOWER(ParentProcessName) LIKE &quot;%explorer.exe&quot;</span>
<span class="sd">    AND LOWER(NewProcessName) LIKE &quot;%3aka3%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="detection-type-general-none">
<h3>Detection Type:General(None)<a class="headerlink" href="#detection-type-general-none" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:DFD6A782-9BDB-4550-AB6B-525E825B095E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 13</span>
<span class="sd">  AND TargetObject RLIKE &#39;.*\\\\\\\\AppCompatFlags\\\\\\\\Compatibility Assistant\\\\\\\\Store\\\\\\\\.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-masquerading">
<h2>1.A.2. Masquerading<a class="headerlink" href="#a-2-masquerading" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used unicode right-to-left override (RTLO) character to obfuscate file name rcs.3aka3.doc (originally cod.3aka.scr)</p>
<p><strong>Criteria:</strong> Evidence of the right-to-left override character (U+202E) in the rcs.3aka.doc process ​OR the original filename (cod.3aka.scr)</p>
<div class="section" id="id1">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F4C71BF4-E068-493D-ABAA-0C5DFA02875D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(Image) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:D94222A0-72F9-4F1E-84A9-F14CA1098D44</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND LOWER(NewProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-uncommonly-used-port">
<h2>1.A.3. Uncommonly Used Port<a class="headerlink" href="#a-3-uncommonly-used-port" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established C2 channel (192.168.0.5) via rcs.3aka3.doc payload over TCP port 1234</p>
<p><strong>Criteria:</strong> Established network channel over port 1234</p>
<div class="section" id="id2">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:B53A710B-43AB-4B57-BD92-4E787D494978</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 3</span>
<span class="sd">    AND LOWER(Image) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:1BAC5645-83CD-4D6F-A4F8-659084401F47</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 5156</span>
<span class="sd">  AND LOWER(Application) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-4-standard-cryptographic-protocol">
<h2>1.A.4. Standard Cryptographic Protocol<a class="headerlink" href="#a-4-standard-cryptographic-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used RC4 stream cipher to encrypt C2 (192.168.0.5) traffic</p>
<p><strong>Criteria:</strong> Evidence that the network data sent over the C2 channel is encrypted</p>
<div class="section" id="detection-type-none-none">
<h3>Detection Type:None(None)<a class="headerlink" href="#detection-type-none-none" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:E12B701E-1222-413C-BCAF-F357CB769B3E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 7</span>
<span class="sd">  AND Image LIKE &quot;%3aka3%&quot;</span>
<span class="sd">  AND LOWER(ImageLoaded) LIKE &#39;%bcrypt.dll&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-command-line-interface">
<h2>1.B.1. Command-Line Interface<a class="headerlink" href="#b-1-command-line-interface" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive cmd.exe</p>
<p><strong>Criteria:</strong> cmd.exe spawning from the rcs.3aka3.doc​ process</p>
<div class="section" id="detection-type-telemetry-correlated">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#detection-type-telemetry-correlated" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:4799C203-573A-49CB-ACE4-8C4C5CD3862A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 1</span>
<span class="sd">  AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">  AND LOWER(Image) LIKE &quot;%cmd.exe&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:C8D664CD-48EE-4663-AE49-D5B0B19014C7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 4688</span>
<span class="sd">  AND LOWER(ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">  AND LOWER(NewProcessName) LIKE &quot;%cmd.exe&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-powershell">
<h2>1.B.2. PowerShell<a class="headerlink" href="#b-2-powershell" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive powershell.exe</p>
<p><strong>Criteria:</strong> powershell.exe spawning from cmd.exe</p>
<div class="section" id="id3">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C1DBF5F2-21D5-45E4-8D9A-44905F1F8242</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">        AND LOWER(Image) LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(Image) LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:43B46661-3407-4302-BA8C-EE772C677DCB</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessId = b.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND LOWER(NewProcessName) LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-file-and-directory-discovery">
<h2>2.A.1. File and Directory Discovery<a class="headerlink" href="#a-1-file-and-directory-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Searched filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem</p>
<div class="section" id="id4">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:10C87900-CC2F-4EE1-A2F2-1832A761B050</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ParentProcessGuid, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT ParentProcessGuid, ProcessGuid, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">      ) d</span>
<span class="sd">  ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ParentProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND LOWER(a.ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:26F6963D-00D5-466A-B4BA-59DA30892B26</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">      ) d</span>
<span class="sd">  ON hex(c.ExecutionProcessID) = d.NewProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.NewProcessId = b.ProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">          AND a.EventID = 4688</span>
<span class="sd">          AND LOWER(a.ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-automated-collection">
<h2>2.A.2. Automated Collection<a class="headerlink" href="#a-2-automated-collection" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Scripted search of filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem</p>
<div class="section" id="id5">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F96EA21C-1EB4-4988-8F98-BD018717EE2D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ParentProcessGuid, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT ParentProcessGuid, ProcessGuid, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">      ) d</span>
<span class="sd">  ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ParentProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND LOWER(a.ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:EAD989D4-8886-46DC-BC8C-780C10760E93</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">      ) d</span>
<span class="sd">  ON hex(c.ExecutionProcessID) = d.NewProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.NewProcessId = b.ProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">          AND a.EventID = 4688</span>
<span class="sd">          AND LOWER(a.ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-data-from-local-system">
<h2>2.A.3. Data from Local System<a class="headerlink" href="#a-3-data-from-local-system" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Recursively collected files found in C:\Users\Pam\ using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe reading files in C:\Users\Pam\</p>
<div class="section" id="id6">
<h3>Detection Type:None(None)<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-4-data-compressed">
<h2>2.A.4. Data Compressed<a class="headerlink" href="#a-4-data-compressed" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Compressed and stored files into ZIP (Draft.zip) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Compress-Archive</p>
<div class="section" id="id7">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6CDEBEBF-387F-4A40-A4E8-8D4DF3A8F897</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ParentProcessGuid, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT ParentProcessGuid, ProcessGuid, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">      ) d</span>
<span class="sd">  ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%compress-archive%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ParentProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND LOWER(a.ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:621F8EE7-E9D8-417C-9FE5-5A0D89C3736A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">      ) d</span>
<span class="sd">  ON hex(c.ExecutionProcessID) = d.NewProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%compress-archive%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.NewProcessId = b.ProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">          AND a.EventID = 4688</span>
<span class="sd">          AND LOWER(a.ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-5-data-staged">
<h2>2.A.5. Data Staged<a class="headerlink" href="#a-5-data-staged" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Staged files for exfiltration into ZIP (Draft.zip) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating the file draft.zip</p>
<div class="section" id="id8">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:76154CEC-1E01-4D3A-B9ED-C78978597C2B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT TargetFilename</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid, d.ProcessId</span>
<span class="sd">    FROM apt29Host c</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid, ProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">        ) d</span>
<span class="sd">    ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">    WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">            AND c.EventID = 4104</span>
<span class="sd">            AND LOWER(c.ScriptBlockText) LIKE &quot;%compress-archive%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND a.EventID = 11</span>
<span class="sd">            AND LOWER(a.TargetFilename) LIKE &quot;%zip&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-exfiltration-over-command-and-control-channel">
<h2>2.B.1. Exfiltration Over Command and Control Channel<a class="headerlink" href="#b-1-exfiltration-over-command-and-control-channel" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read and downloaded ZIP (Draft.zip) over C2 channel (192.168.0.5 over TCP port 1234)</p>
<p><strong>Criteria:</strong> The rcs.3aka3.doc process reading the file draft.zip while connected to the C2 channel</p>
<div class="section" id="id9">
<h3>Detection Type:None(None)<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-1-remote-file-copy">
<h2>3.A.1. Remote File Copy<a class="headerlink" href="#a-1-remote-file-copy" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped stage 2 payload (monkey.png) to disk</p>
<p><strong>Criteria:</strong> The rcs.3aka3.doc process creating the file monkey.png</p>
<div class="section" id="id10">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:64249901-ADF8-4E5D-8BB4-70540A45E26C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid, Message</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 11</span>
<span class="sd">        AND LOWER(TargetFilename) LIKE &#39;%monkey.png&#39;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND a.EventID = 1</span>
<span class="sd">  AND LOWER(a.Image) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-obfuscated-files-or-information">
<h2>3.A.2. Obfuscated Files or Information<a class="headerlink" href="#a-2-obfuscated-files-or-information" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Embedded PowerShell payload in monkey.png using steganography</p>
<p><strong>Criteria:</strong> Evidence that a PowerShell payload was within monkey.png</p>
<div class="section" id="id11">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0F10E1D1-EDF8-4B9F-B879-3651598D528A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT d.Image, d.CommandLine, c.ScriptBlockText</span>
<span class="sd">FROM apt29Host c</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ParentProcessGuid, ProcessGuid, ProcessId, ParentImage, Image, ParentCommandLine, CommandLine</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">    ) d</span>
<span class="sd">ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND c.EventID = 4104</span>
<span class="sd">    AND LOWER(c.ScriptBlockText) LIKE &quot;%monkey.png%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:94F9B4F2-1C52-4A47-BF47-C786513A05AA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT d.NewProcessName, d.CommandLine, c.ScriptBlockText</span>
<span class="sd">FROM apt29Host c</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessName, CommandLine, split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">    ) d</span>
<span class="sd">ON LOWER(hex(c.ExecutionProcessID)) = d.NewProcessId</span>
<span class="sd">WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND c.EventID = 4104</span>
<span class="sd">    AND LOWER(c.ScriptBlockText) LIKE &quot;%monkey.png%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-component-object-model-hijacking">
<h2>3.B.1. Component Object Model Hijacking<a class="headerlink" href="#b-1-component-object-model-hijacking" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Modified the Registry to enable COM hijacking of sdclt.exe using PowerShell</p>
<p><strong>Criteria:</strong> Addition of the DelegateExecute ​subkey in ​HKCU\Software\Classes\Folder\shell\open\​​command​​</p>
<div class="section" id="id12">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:04EB334D-A304-40D9-B177-0BB6E95FC23E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 13</span>
<span class="sd">    AND LOWER(TargetObject) RLIKE &#39;.*\\\\\\\\folder\\\\\\\\shell\\\\\\\\open\\\\\\\\command\\\\\\\delegateexecute.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-bypass-user-account-control">
<h2>3.B.2. Bypass User Account Control<a class="headerlink" href="#b-2-bypass-user-account-control" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed elevated PowerShell payload</p>
<p><strong>Criteria:</strong> High integrity powershell.exe spawning from control.exe​​ (spawned from sdclt.exe)</p>
<div class="section" id="id13">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6C8780E9-E6AF-4210-8EA0-72E9017CEE7D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND a.EventID = 1</span>
<span class="sd">    AND a.IntegrityLevel = &quot;High&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:EE34D18C-0549-4AFB-8B98-01160B0C9094</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessId = b.NewProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">    AND a.EventID = 4688</span>
<span class="sd">    AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">    AND a.TokenElevationType = &quot;%%1937&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-commonly-used-port">
<h2>3.B.3. Commonly Used Port<a class="headerlink" href="#b-3-commonly-used-port" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established C2 channel (192.168.0.5) via PowerShell payload over TCP port 443</p>
<p><strong>Criteria:</strong> Established network channel over port 443</p>
<div class="section" id="id14">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:E209D0C5-5A2B-4AEC-92B0-1510165B8EC7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessGuid = c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:2E9B9ADC-2426-419F-8E6E-2D9338384F80</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(a.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON LOWER(hex(CAST(ProcessId as INT))) = c.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 5156</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-standard-application-layer-protocol">
<h2>3.B.4. Standard Application Layer Protocol<a class="headerlink" href="#b-4-standard-application-layer-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used HTTPS to transport C2 (192.168.0.5) traffic</p>
<p><strong>Criteria:</strong> Evidence that the network data sent over the C2 channel is HTTPS</p>
<div class="section" id="id15">
<h3>Detection Type:None(None)<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-5-standard-cryptographic-protocol">
<h2>3.B.5. Standard Cryptographic Protocol<a class="headerlink" href="#b-5-standard-cryptographic-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used HTTPS to encrypt C2 (192.168.0.5) traffic</p>
<p><strong>Criteria:</strong> Evidence that the network data sent over the C2 channel is encrypted</p>
<div class="section" id="id16">
<h3>Detection Type:None(None)<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="c-1-modify-registry">
<h2>3.C.1. Modify Registry<a class="headerlink" href="#c-1-modify-registry" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Modified the Registry to remove artifacts of COM hijacking</p>
<p><strong>Criteria:</strong> Deletion of of the HKCU\Software\Classes\Folder\shell\Open\command subkey</p>
<div class="section" id="id17">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:22A46621-7A92-48C1-81BF-B3937EB4FDC3</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT b.ProcessGuid</span>
<span class="sd">    FROM apt29Host b</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">    ) a</span>
<span class="sd">    ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">    WHERE b.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND b.EventID = 1</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessGuid = c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 12</span>
<span class="sd">  AND LOWER(d.TargetObject) RLIKE &#39;.*\\\\\\\\folder\\\\\\\\shell\\\\\\\\open\\\\\\\\command.*&#39;</span>
<span class="sd">  AND d.Message RLIKE &#39;.*EventType: DeleteKey.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id18">
<h2>4.A.1. Remote File Copy<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped additional tools (SysinternalsSuite.zip) to disk over C2 channel (192.168.0.5)</p>
<p><strong>Criteria:</strong> powershell.exe creating the file SysinternalsSuite.zip</p>
<div class="section" id="id19">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:337EA65D-55A7-4890-BB2A-6A08BB9703E2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT b.ProcessGuid</span>
<span class="sd">    FROM apt29Host b</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">    ) a</span>
<span class="sd">    ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">    WHERE b.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND b.EventID = 1</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessGuid = c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 11</span>
<span class="sd">  AND LOWER(d.TargetFilename) LIKE &#39;%.zip&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-powershell">
<h2>4.A.2. PowerShell<a class="headerlink" href="#a-2-powershell" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive powershell.exe</p>
<p><strong>Criteria:</strong> powershell.exe spawning from powershell.exe</p>
<div class="section" id="id20">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:B86F90BD-716C-4432-AE97-901174F111A8</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:FA520225-1813-4EF2-BA58-98CB59C897D7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessId = c.NewProcessId</span>
<span class="sd">WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-deobfuscate-decode-files-or-information">
<h2>4.A.3. Deobfuscate/Decode Files or Information<a class="headerlink" href="#a-3-deobfuscate-decode-files-or-information" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Decompressed ZIP (SysinternalsSuite.zip) file using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Expand-Archive</p>
<div class="section" id="id21">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:09F29912-8E93-461E-9E89-3F06F6763383</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%expand-archive%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:4310F2AF-11EF-4EAC-A968-3436FE5F6140</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%expand-archive%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-process-discovery">
<h2>4.B.1. Process Discovery<a class="headerlink" href="#b-1-process-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated current running processes using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-Process</p>
<div class="section" id="id22">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:CE6D61C3-C3B5-43D2-BD3C-4C1711A822DA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:294DFB34-1FA8-464D-B85C-F2AE163DB4A9</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-file-deletion">
<h2>4.B.2. File Deletion<a class="headerlink" href="#b-2-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted rcs.3aka3.doc on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file rcs.3aka3.doc</p>
<div class="section" id="id23">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:5EED5350-0BFD-4501-8B2D-4CE4F8F9E948</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ProcessGuid</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%3aka3%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:59A9AC92-124D-4C4B-A6BF-3121C98677C3</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">        FROM apt29Host a</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">              AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">        ) b</span>
<span class="sd">        ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">        WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">      WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND d.EventID = 1</span>
<span class="sd">        AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND f.EventID = 1</span>
<span class="sd">      AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">      AND LOWER(f.CommandLine) LIKE &#39;%3aka3%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID in (12,13)</span>
<span class="sd">    AND LOWER(h.TargetObject) RLIKE &#39;.*\\\\\\\\software\\\\\\\\sysinternals\\\\\\\\sdelete.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:3A1DC1C2-B640-4FCE-A71F-2F65AB060A8C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">  AND f.EventID = 4688</span>
<span class="sd">  AND LOWER(f.NewProcessName) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">  AND LOWER(f.CommandLine) LIKE &#39;%3aka3%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-file-deletion">
<h2>4.B.3. File Deletion<a class="headerlink" href="#b-3-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted Draft.zip on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file draft.zip</p>
<div class="section" id="id24">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:02D0BBFB-4BDF-4167-B530-253779745EF7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message, g.CommandLine</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid, f.CommandLine</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%draft.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:719618E8-9EE7-4693-937E-1FD39228DEBC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%draft.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID in (12,13)</span>
<span class="sd">  AND LOWER(h.TargetObject) RLIKE &#39;.*\\\\\\\\software\\\\\\\\sysinternals\\\\\\\\sdelete.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:5A19E46B-8328-4867-81CF-87518A3784B1</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.NewProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN(</span>
<span class="sd">  SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ProcessId = b.NewProcessId</span>
<span class="sd">  WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">    AND a.EventID = 4688</span>
<span class="sd">    AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">    AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessId = c.NewProcessId</span>
<span class="sd">WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">  AND d.EventID = 4688</span>
<span class="sd">  AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">AND f.EventID = 4688</span>
<span class="sd">AND LOWER(f.NewProcessName) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">AND LOWER(f.CommandLine) LIKE &#39;%draft.zip&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-file-deletion">
<h2>4.B.4. File Deletion<a class="headerlink" href="#b-4-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted SysinternalsSuite.zip on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file SysinternalsSuite.zip</p>
<div class="section" id="id25">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:83D62033-105A-4A02-8B75-DAB52D8D51EC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message, g.CommandLine</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid, f.CommandLine</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%sysinternalssuite.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:AC2ECFF0-D817-4893-BDED-F16B837C4DBA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%sysinternalssuite.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID in (12,13)</span>
<span class="sd">  AND LOWER(h.TargetObject) RLIKE &#39;.*\\\\\\\\software\\\\\\\\sysinternals\\\\\\\\sdelete.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:4D6DE690-E92C-4D60-93E6-8E5C7C4DF143</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.NewProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN(</span>
<span class="sd">  SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ProcessId = b.NewProcessId</span>
<span class="sd">  WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">    AND a.EventID = 4688</span>
<span class="sd">    AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">    AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessId = c.NewProcessId</span>
<span class="sd">WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">  AND d.EventID = 4688</span>
<span class="sd">  AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">AND f.EventID = 4688</span>
<span class="sd">AND LOWER(f.NewProcessName) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">AND LOWER(f.CommandLine) LIKE &#39;%sysinternalssuite.zip&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-1-file-and-directory-discovery">
<h2>4.C.1. File and Directory Discovery<a class="headerlink" href="#c-1-file-and-directory-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated user’s temporary directory path using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:TEMP</p>
<div class="section" id="id26">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:85BFD73C-875E-4208-AD9E-1922D4D4D991</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:temp%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:D18CF7B9-CBF0-40CE-9D07-12DC83AF3B2F</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:temp%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-2-system-owner-user-discovery">
<h2>4.C.2. System Owner/User Discovery<a class="headerlink" href="#c-2-system-owner-user-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the current username using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:USERNAME</p>
<div class="section" id="id27">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:A45F53ED-65CB-4739-A4D3-F2B0F08F86F8</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:username%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:6F3D1615-69D6-41C6-90D0-39ACA14941BD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:username%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-3-system-information-discovery">
<h2>4.C.3. System Information Discovery<a class="headerlink" href="#c-3-system-information-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the computer hostname using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:COMPUTERNAME</p>
<div class="section" id="id28">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:9B610803-2B27-4DA4-9AAC-C859F48510DA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:computername%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:1BA09833-CDF3-44BE-86D0-6F5B1C66D151</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:computername%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-4-system-network-configuration-discovery">
<h2>4.C.4. System Network Configuration Discovery<a class="headerlink" href="#c-4-system-network-configuration-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the current domain name using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:USERDOMAIN</p>
<div class="section" id="id29">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1418A09E-BC90-4BC5-A0BC-1ECC4283ACF4</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:userdomain%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:8D215D46-CE33-4CB7-9934-FF9205971570</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:userdomain%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-5-process-discovery">
<h2>4.C.5. Process Discovery<a class="headerlink" href="#c-5-process-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the current process ID using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $PID</p>
<div class="section" id="id30">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:2DBE08DB-BADD-40AD-A037-DEBD29E207C6</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$pid%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:9CFC783B-2DC8-4A3D-AC7B-2DF890827E2E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$pid%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-6-system-information-discovery">
<h2>4.C.6. System Information Discovery<a class="headerlink" href="#c-6-system-information-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the OS version using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing​ Gwmi Win32_OperatingSystem</p>
<div class="section" id="id31">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:5A2B7006-A887-465F-9D41-AED8F6AECBE1</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%gwmi win32_operatingsystem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:69A3B3AC-42BE-44F6-A418-C2356894F745</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%gwmi win32_operatingsystem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-7-security-software-discovery">
<h2>4.C.7. Security Software Discovery<a class="headerlink" href="#c-7-security-software-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated anti-virus software using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing​ Get-WmiObject …​ -Class AntiVirusProduct</p>
<div class="section" id="id32">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:E1E0849D-1771-438B-9D8F-A67B7EC48B97</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class antivirusproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:956D78C8-FCB5-440D-B059-6790F729D02D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class antivirusproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-8-security-software-discovery">
<h2>4.C.8. Security Software Discovery<a class="headerlink" href="#c-8-security-software-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated firewall software using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-WmiObject …​​ -Class FireWallProduct</p>
<div class="section" id="id33">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:9F924458-73AD-42C8-B98E-0CB4B4355B9B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class firewallproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:B7549913-AF53-4F9A-9C3F-4106578EA5F2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class firewallproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-9-permission-groups-discovery">
<h2>4.C.9. Permission Groups Discovery<a class="headerlink" href="#c-9-permission-groups-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated user’s domain group membership via the NetUserGetGroups API</p>
<p><strong>Criteria:</strong> powershell.exe executing the NetUserGetGroups API</p>
<div class="section" id="detection-type-technique-alert">
<h3>Detection Type:technique(alert)<a class="headerlink" href="#detection-type-technique-alert" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:FA458669-1C94-4150-AFFC-A3236FC6B275</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT a.EventTime, o.TargetUserName, o.IpAddress, a.Message</span>
<span class="sd">FROM apt29Host o</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT Message, EventTime, SubjectLogonId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE lower(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4661</span>
<span class="sd">        AND ObjectType = &quot;SAM_DOMAIN&quot;</span>
<span class="sd">        AND SubjectUserName NOT LIKE &#39;%$&#39;</span>
<span class="sd">        AND AccessMask = &#39;0x20094&#39;</span>
<span class="sd">        AND LOWER(Message) LIKE &#39;%getlocalgroupmembership%&#39;</span>
<span class="sd">    ) a</span>
<span class="sd">ON o.TargetLogonId = a.SubjectLogonId</span>
<span class="sd">WHERE lower(Channel) = &quot;security&quot; </span>
<span class="sd">        AND o.EventID = 4624</span>
<span class="sd">        AND o.LogonType = 3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id34">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:11827B7C-8010-443C-9116-500289E0ED57</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:52E7DFEA-05BC-4B81-BFE9-DE6085FA8228</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-10-execution-through-api">
<h2>4.C.10. Execution through API<a class="headerlink" href="#c-10-execution-through-api" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed API call by reflectively loading Netapi32.dll</p>
<p><strong>Criteria:</strong> The NetUserGetGroups API function loaded into powershell.exe from Netapi32.dll</p>
<div class="section" id="id35">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0B50643F-98FA-4F4A-8E22-9257D85AD7C5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">AND f.EventID = 7</span>
<span class="sd">AND LOWER(f.ImageLoaded) LIKE &quot;%netapi32.dll&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-11-permission-groups-discovery">
<h2>4.C.11. Permission Groups Discovery<a class="headerlink" href="#c-11-permission-groups-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated user’s local group membership via the NetUserGetLocalGroups API</p>
<p><strong>Criteria:</strong> powershell.exe executing the NetUserGetLocalGroups API</p>
<div class="section" id="id36">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1CD16ED8-C812-40B1-B968-F0DABFC79DDF</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetlocalgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:F0AC46E2-63EA-4C8E-AF39-6631444451E5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetlocalgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-12-execution-through-api">
<h2>4.C.12. Execution through API<a class="headerlink" href="#c-12-execution-through-api" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed API call by reflectively loading Netapi32.dll</p>
<p><strong>Criteria:</strong> The NetUserGetLocalGroups API function loaded into powershelle.exe from Netapi32.dll</p>
<div class="section" id="id37">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:53CEF026-66EF-4B26-B5C9-10D4BBA3F9E8</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">AND f.EventID = 7</span>
<span class="sd">AND LOWER(f.ImageLoaded) LIKE &quot;%netapi32.dll&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-new-service">
<h2>5.A.1. New Service<a class="headerlink" href="#a-1-new-service" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Created a new service (javamtsup) that executes a service binary (javamtsup.exe) at system startup</p>
<p><strong>Criteria:</strong> powershell.exe creating the Javamtsup service</p>
<div class="section" id="id38">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:A16CE10D-6EE3-4611-BE9B-B023F36E2DFF</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID IN (12,13,14)</span>
<span class="sd">  AND (LOWER(TargetObject) LIKE &quot;%javamtsup%&quot; OR LOWER(Details) LIKE &quot;%javamtsup%&quot;)</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:E76C4174-C24A-4CA3-9EA8-46C5286D3B6F</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4103</span>
<span class="sd">  AND LOWER(f.Payload) LIKE &quot;%new-service%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:AA3EF640-2720-4E8A-B86D-DFCF2FDB86BD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4103</span>
<span class="sd">  AND LOWER(f.Payload) LIKE &quot;%new-service%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-registry-run-keys-startup-folder">
<h2>5.B.1. Registry Run Keys / Startup Folder<a class="headerlink" href="#b-1-registry-run-keys-startup-folder" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Created a LNK file (hostui.lnk) in the Startup folder that executes on login</p>
<p><strong>Criteria:</strong> powershell.exe creating the file hostui.lnk in the Startup folder</p>
<div class="section" id="id39">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:611FCA99-97D0-4873-9E51-1C1BA2DBB40D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 11</span>
<span class="sd">    AND f.TargetFilename RLIKE &#39;.*\\\\\\\\ProgramData\\\\\\\\Microsoft\\\\\\\\Windows\\\\\\\\Start Menu\\\\\\\\Programs\\\\\\\\StartUp.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-credentials-in-files">
<h2>6.A.1. Credentials in Files<a class="headerlink" href="#a-1-credentials-in-files" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read the Chrome SQL database file to extract encrypted credentials</p>
<p><strong>Criteria:</strong> accesschk.exe reading files within %APPDATALOCAL%\Google\chrome\user data\default\</p>
<div class="section" id="id40">
<h3>Detection Type:None(None)<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-2-credential-dumping">
<h2>6.A.2. Credential Dumping<a class="headerlink" href="#a-2-credential-dumping" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed the CryptUnprotectedData API call to decrypt Chrome passwords</p>
<p><strong>Criteria:</strong> accesschk.exe executing the CryptUnprotectedData API</p>
<div class="section" id="id41">
<h3>Detection Type:None(None)<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-3-masquerading">
<h2>6.A.3. Masquerading<a class="headerlink" href="#a-3-masquerading" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Masqueraded a Chrome password dump tool as accesscheck.exe, a legitimate Sysinternals tool</p>
<p><strong>Criteria:</strong> Evidence that accesschk.exe is not the legitimate Sysinternals tool</p>
<div class="section" id="id42">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0A19F9B7-5E17-47E5-8015-29E9ABC09ADC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">        FROM apt29Host a</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">              AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">        ) b</span>
<span class="sd">        ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">        WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">      WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND d.EventID = 1</span>
<span class="sd">        AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND f.EventID = 1</span>
<span class="sd">      AND LOWER(f.Image) LIKE &#39;%accesschk%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 7</span>
<span class="sd">    AND LOWER(ImageLoaded) LIKE &#39;%accesschk%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="detection-type-general-correlated">
<h3>Detection Type:General(Correlated)<a class="headerlink" href="#detection-type-general-correlated" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1FCE98FC-1FF9-41CB-9C25-0235729A2B01</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">        FROM apt29Host a</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">              AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">        ) b</span>
<span class="sd">        ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">        WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">      WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND d.EventID = 1</span>
<span class="sd">        AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND f.EventID = 1</span>
<span class="sd">      AND LOWER(f.Image) LIKE &#39;%accesschk%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 7</span>
<span class="sd">    AND LOWER(ImageLoaded) LIKE &#39;%accesschk%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-private-keys">
<h2>6.B.1. Private Keys<a class="headerlink" href="#b-1-private-keys" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Exported a local certificate to a PFX file using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating a certificate file exported from the system</p>
<div class="section" id="id43">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6392C9F1-D975-4F75-8A70-433DEDD7F622</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">AND f.EventID = 11</span>
<span class="sd">AND LOWER(f.TargetFilename) LIKE &quot;%.pfx&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-1-credential-dumping">
<h2>6.C.1. Credential Dumping<a class="headerlink" href="#c-1-credential-dumping" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dumped password hashes from the Windows Registry by injecting a malicious DLL into Lsass.exe</p>
<p><strong>Criteria:</strong> powershell.exe injecting into lsass.exe OR lsass.exe reading Registry keys under HKLM:\SAM\SAM\Domains\Account\Users\</p>
<div class="section" id="id44">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:7B2CE2A5-4386-4EED-9A03-9B7D1049C4AE</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.SourceProcessGuid = e.ParentProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 8</span>
<span class="sd">    AND f.TargetImage LIKE &#39;%lsass.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-screen-capture">
<h2>7.A.1. Screen Capture<a class="headerlink" href="#a-1-screen-capture" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Captured and saved screenshots using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing the CopyFromScreen function from System.Drawing.dll</p>
<div class="section" id="id45">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:3B4E5808-3C71-406A-B181-17B0CE3178C9</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 7</span>
<span class="sd">    AND LOWER(f.ImageLoaded) LIKE &quot;%system.drawing.ni.dll&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id46">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:B374D3E7-3580-441F-8D6E-48C40CBA7922</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%copyfromscreen%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:2AA4D448-3893-4F31-9497-0F8E2B7E3CFD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%copyfromscreen%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-clipboard-data">
<h2>7.A.2. Clipboard Data<a class="headerlink" href="#a-2-clipboard-data" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Captured clipboard contents using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-Clipboard</p>
<div class="section" id="id47">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F4609F7E-C4DB-4327-91D4-59A58C962A02</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%get-clipboard%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:6EC8D7EB-153B-459A-9333-51208449DB99</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%get-clipboard%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-input-capture">
<h2>7.A.3. Input Capture<a class="headerlink" href="#a-3-input-capture" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Captured user keystrokes using the GetAsyncKeyState API</p>
<p><strong>Criteria:</strong> powershell.exe executing the GetAsyncKeyState API</p>
<div class="section" id="id48">
<h3>Detection Type:None(None)<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-1-data-from-local-system">
<h2>7.B.1. Data from Local System<a class="headerlink" href="#b-1-data-from-local-system" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read data in the user’s Downloads directory using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe reading files in C:\Users\pam\Downloads\</p>
<div class="section" id="id49">
<h3>Detection Type:None(None)<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-2-data-compressed">
<h2>7.B.2. Data Compressed<a class="headerlink" href="#b-2-data-compressed" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Compressed data from the user’s Downloads directory into a ZIP file (OfficeSupplies.7z) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating the file OfficeSupplies.7z</p>
<div class="section" id="id50">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:BA68938F-7506-4E20-BC06-0B44B535A0B1</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND f.EventID = 11</span>
<span class="sd">  AND LOWER(f.TargetFilename) LIKE &#39;%officesupplies%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-data-encrypted">
<h2>7.B.3. Data Encrypted<a class="headerlink" href="#b-3-data-encrypted" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Encrypted data from the user’s Downloads directory using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Compress-7Zip with the password argument used for encryption</p>
<div class="section" id="id51">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:4C19DDB9-9763-4D1C-9B9D-788ECF193778</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%compress-7zip%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:C670DAFF-B1FD-45B2-9DEB-AC5AEC273EE7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4104</span>
<span class="sd">AND LOWER(f.ScriptBlockText) LIKE &quot;%compress-7zip%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-exfiltration-over-alternative-protocol">
<h2>7.B.4. Exfiltration Over Alternative Protocol<a class="headerlink" href="#b-4-exfiltration-over-alternative-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Exfiltrated collection (OfficeSupplies.7z) to WebDAV network share using PowerShell</p>
<p><strong>Criteria:</strong> powershell executing Copy-Item pointing to an attack-controlled WebDav network share (192.168.0.4:80)</p>
<div class="section" id="id52">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:7AAC6658-2B5C-4B4A-B7C9-D42D288D5218</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%copy-item%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:B19F8E16-AA6C-45C1-8A0D-92812830C237</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4104</span>
<span class="sd">AND LOWER(f.ScriptBlockText) LIKE &quot;%copy-item%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id53">
<h3>Detection Type:technique(Alert)<a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C10730EA-6345-4934-AA0F-B0EFCA0C4BA6</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND CommandLine RLIKE &#39;.*rundll32.exe.*\\\\\\\\windows\\\\\\\\system32\\\\\\\\davclnt.dll.*DavSetCookie.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-remote-system-discovery">
<h2>8.A.1. Remote System Discovery<a class="headerlink" href="#a-1-remote-system-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated remote systems using LDAP queries</p>
<p><strong>Criteria:</strong> powershell.exe making LDAP queries over port 389 to the Domain Controller (10.0.0.4)</p>
<div class="section" id="id54">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C1307FC1-19B7-467B-9705-95147B492CC7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">  WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND a.EventID = 1</span>
<span class="sd">    AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 1</span>
<span class="sd">  AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND f.EventID = 3</span>
<span class="sd">  AND f.DestinationPort = 389</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:542C2E36-0BC0-450B-A34F-C600E9DC396B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(CAST(f.ProcessId as INT))) = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 5156</span>
<span class="sd">    AND DestPort = 389</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-remote-system-discovery">
<h2>8.A.2. Remote System Discovery<a class="headerlink" href="#a-2-remote-system-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established WinRM connection to remote host NASHUA (10.0.1.6)</p>
<p><strong>Criteria:</strong> Network connection to NASHUA (10.0.1.6) over port 5985</p>
<div class="section" id="id55">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0A5428EA-171D-4944-B27C-0EBC3D557FAD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">  WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND a.EventID = 1</span>
<span class="sd">    AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 1</span>
<span class="sd">  AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND f.EventID = 3</span>
<span class="sd">  AND f.DestinationPort = 5985</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:0376E07E-3C48-4B89-A50D-B3FAAB23EDAB</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(CAST(f.ProcessId as INT))) = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 5156</span>
<span class="sd">    AND DestPort = 5985</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-process-discovery">
<h2>8.A.3. Process Discovery<a class="headerlink" href="#a-3-process-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated processes on remote host Scranton (10.0.1.4) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-Process</p>
<div class="section" id="id56">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6C481791-2AE8-4F6B-9BFE-C1F6DE1E0BC0</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid, ProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(Image) LIKE &#39;%wsmprovhost.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.ExecutionProcessID = a.ProcessId</span>
<span class="sd">WHERE b.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND b.EventID = 4104</span>
<span class="sd">  AND LOWER(b.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:088846AF-FF45-4FC4-896C-64F24517BBD7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">      AND EventID = 4688</span>
<span class="sd">      AND LOWER(NewProcessName) LIKE &#39;%wsmprovhost.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON LOWER(hex(b.ExecutionProcessID)) = a.NewProcessId</span>
<span class="sd">WHERE b.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND b.EventID = 4104</span>
<span class="sd">AND LOWER(b.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-remote-file-copy">
<h2>8.B.1. Remote File Copy<a class="headerlink" href="#b-1-remote-file-copy" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Copied python.exe payload from a WebDAV share (192.168.0.4) to remote host Scranton (10.0.1.4)</p>
<p><strong>Criteria:</strong> The file python.exe created on Scranton (10.0.1.4)</p>
<div class="section" id="id57">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:97402495-2449-415F-BDAD-5CC8EFC1E1B5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 5145</span>
<span class="sd">  AND RelativeTargetName LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:D804F2D8-C65B-42D6-A731-C13BE2BDB441</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &#39;Microsoft-Windows-Sysmon/Operational&#39;</span>
<span class="sd">    AND EventID = 11</span>
<span class="sd">    AND TargetFilename LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-software-packing">
<h2>8.B.2. Software Packing<a class="headerlink" href="#b-2-software-packing" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> python.exe payload was packed with UPX</p>
<p><strong>Criteria:</strong> Evidence that the file python.exe is packed</p>
<div class="section" id="id58">
<h3>Detection Type:None(None)<a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="c-1-valid-accounts">
<h2>8.C.1. Valid Accounts<a class="headerlink" href="#c-1-valid-accounts" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Logged on to remote host NASHUA (10.0.1.6) using valid credentials for user Pam</p>
<p><strong>Criteria:</strong> Successful logon as user Pam on NASHUA (10.0.1.6)</p>
<div class="section" id="id59">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:AF5E8E22-DEC8-40AF-98AD-84BE1AC3F34C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Hostname, a.Message</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT TargetLogonId, Message</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4624</span>
<span class="sd">        AND LogonType = 3</span>
<span class="sd">        AND TargetUserName NOT LIKE &#39;%$&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.SubjectLogonId = a.TargetLogonId</span>
<span class="sd">WHERE LOWER(b.Channel) = &quot;security&quot;</span>
<span class="sd">  AND b.EventID = 5145</span>
<span class="sd">  AND b.RelativeTargetName LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-2-windows-admin-shares">
<h2>8.C.2. Windows Admin Shares<a class="headerlink" href="#c-2-windows-admin-shares" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established SMB session to remote host NASHUA’s (10.0.1.6) IPC$ share using PsExec</p>
<p><strong>Criteria:</strong> SMB session to NASHUA (10.0.1.6) over TCP port 445/135 OR evidence of usage of a Windows share</p>
<div class="section" id="id60">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C91A4BF2-22B1-421B-B1DE-626778AD3BBB</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT EventTime, Hostname, ShareName, RelativeTargetName, SubjectUserName</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 5145</span>
<span class="sd">  AND ShareName LIKE &#39;%IPC%&#39;</span>
<span class="sd">  AND RelativeTargetName LIKE &#39;%PSEXESVC%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-3-service-execution">
<h2>8.C.3. Service Execution<a class="headerlink" href="#c-3-service-execution" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed python.exe using PSExec</p>
<p><strong>Criteria:</strong> python.exe spawned by PSEXESVC.exe</p>
<div class="section" id="id61">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:BDE98B9B-77DD-4AD4-B755-463C3C27EE5F</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND Image LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:11D81CCD-163F-4347-8F1D-072F4B4B3B26</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.ProcessId = a.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND NewProcessName LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id62">
<h2>9.A.1. Remote File Copy<a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped rar.exe to disk on remote host NASHUA (10.0.1.6)</p>
<p><strong>Criteria:</strong> python.exe creating the file rar.exe</p>
<div class="section" id="id63">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1C94AFAF-74A9-4578-B026-7AA6948D9DBE</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.ProcessGuid</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 11</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-remote-file-copy">
<h2>9.A.2. Remote File Copy<a class="headerlink" href="#a-2-remote-file-copy" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped rar.exe to disk on remote host NASHUA (10.0.1.6)</p>
<p><strong>Criteria:</strong> python.exe creating the file sdelete64.exe</p>
<div class="section" id="id64">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id64" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F98D589E-94A9-4974-A142-7E75D9760118</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.ProcessGuid</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 11</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-powershell">
<h2>9.B.1. PowerShell<a class="headerlink" href="#b-1-powershell" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive powershell.exe</p>
<p><strong>Criteria:</strong> powershell.exe​ spawning from python.exe</p>
<div class="section" id="id65">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id65" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:77D403CE-2832-4927-B74A-42D965B5AF94</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.ProcessGuid</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">) e</span>
<span class="sd">ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND Image LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:B56C6666-EEF3-4028-85D4-6AAE01CD506C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.NewProcessId</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT NewProcessId</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND EventID = 4688</span>
<span class="sd">              AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ProcessId = a.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-file-and-directory-discovery">
<h2>9.B.2. File and Directory Discovery<a class="headerlink" href="#b-2-file-and-directory-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Searched filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem​</p>
<div class="section" id="id66">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id66" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:3DDF2B9B-10AC-454C-BFA0-1F7BD011947E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ExecutionProcessID = g.ProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:E7ED941E-F3B3-441B-B43D-1F1B194D6303</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(f.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON LOWER(hex(h.ExecutionProcessID)) = g.NewProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-automated-collection">
<h2>9.B.3. Automated Collection<a class="headerlink" href="#b-3-automated-collection" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Scripted search of filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem</p>
<div class="section" id="id67">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id67" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6AE2BDBE-48BD-4323-8572-B2214D244013</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ExecutionProcessID = g.ProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:6A0DF333-5329-42B5-9AF6-60AB647051CD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(f.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON LOWER(hex(h.ExecutionProcessID)) = g.NewProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-data-from-local-system">
<h2>9.B.4. Data from Local System<a class="headerlink" href="#b-4-data-from-local-system" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Recursively collected files found in C:\Users\Pam\ using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe reading files in C:\Users\Pam\</p>
<div class="section" id="id68">
<h3>Detection Type:None(None)<a class="headerlink" href="#id68" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-5-data-staged">
<h2>9.B.5. Data Staged<a class="headerlink" href="#b-5-data-staged" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Staged files for exfiltration into ZIP (working.zip in AppData directory) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating the file working.zip</p>
<div class="section" id="id69">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id69" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:17B04626-D628-4CFC-9EF1-7FF9CD48FF5E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 11</span>
<span class="sd">    AND LOWER(h.TargetFilename) LIKE &quot;%working.zip&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-6-data-encrypted">
<h2>9.B.6. Data Encrypted<a class="headerlink" href="#b-6-data-encrypted" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Encrypted staged ZIP (working.zip in AppData directory) into working.zip (on Desktop) using rar.exe</p>
<p><strong>Criteria:</strong> powershell.exe executing rar.exe with the -a parameter for a password to use for encryption</p>
<div class="section" id="id70">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id70" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:9EC44B89-9B82-41F2-B11E-D49392853C63</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 1</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:579D025B-DFFB-416B-B07A-A36D9CE1EF93</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessId = g.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND h.EventID = 4688</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-7-data-compressed">
<h2>9.B.7. Data Compressed<a class="headerlink" href="#b-7-data-compressed" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Compressed staged ZIP (working.zip in AppData directory) into working.zip (on Desktop) using rar.exe</p>
<p><strong>Criteria:</strong> powershell.exe executing rar.exe</p>
<div class="section" id="id71">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id71" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:FD1AE986-FD91-4B91-8BCE-42C9295949F7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 1</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:8A865709-E762-4A26-BDEC-A762FB37947B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessId = g.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND h.EventID = 4688</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-8-exfiltration-over-command-and-control-channel">
<h2>9.B.8. Exfiltration Over Command and Control Channel<a class="headerlink" href="#b-8-exfiltration-over-command-and-control-channel" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read and downloaded ZIP (working.zip on Desktop) over C2 channel (192.168.0.5 over TCP port 8443)</p>
<p><strong>Criteria:</strong> python.exe reading the file working.zip while connected to the C2 channel</p>
<div class="section" id="id72">
<h3>Detection Type:None(None)<a class="headerlink" href="#id72" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="c-1-file-deletion">
<h2>9.C.1. File Deletion<a class="headerlink" href="#c-1-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted rar.exe on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file rar.exe</p>
<div class="section" id="id73">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id73" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C20D8999-0B0D-4A50-9CDC-2BAAC4C7B577</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host j</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT h.ProcessGuid</span>
<span class="sd">    FROM apt29Host h</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT f.ProcessGuid</span>
<span class="sd">        FROM apt29Host f</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT d.ProcessGuid</span>
<span class="sd">          FROM apt29Host d</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">              SELECT b.ProcessGuid</span>
<span class="sd">              FROM apt29Host b</span>
<span class="sd">              INNER JOIN (</span>
<span class="sd">                SELECT ProcessGuid</span>
<span class="sd">                FROM apt29Host</span>
<span class="sd">                WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                    AND EventID = 1</span>
<span class="sd">                    AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">              ) a</span>
<span class="sd">              ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">              WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">          ) c</span>
<span class="sd">          ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">        ) e</span>
<span class="sd">        ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">    ) g</span>
<span class="sd">    ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND h.EventID = 1</span>
<span class="sd">) i</span>
<span class="sd">ON j.ProcessGuid = i.ProcessGuid</span>
<span class="sd">WHERE j.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND j.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-2-file-deletion">
<h2>9.C.2. File Deletion<a class="headerlink" href="#c-2-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted working.zip (from Desktop) on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file \Desktop\working.zip</p>
<div class="section" id="id74">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id74" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:CB869916-7BCF-4F9F-8B95-C19B407B91E3</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host j</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT h.ProcessGuid</span>
<span class="sd">    FROM apt29Host h</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT f.ProcessGuid</span>
<span class="sd">        FROM apt29Host f</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT d.ProcessGuid</span>
<span class="sd">          FROM apt29Host d</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">              SELECT b.ProcessGuid</span>
<span class="sd">              FROM apt29Host b</span>
<span class="sd">              INNER JOIN (</span>
<span class="sd">                SELECT ProcessGuid</span>
<span class="sd">                FROM apt29Host</span>
<span class="sd">                WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                    AND EventID = 1</span>
<span class="sd">                    AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">              ) a</span>
<span class="sd">              ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">              WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">          ) c</span>
<span class="sd">          ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">        ) e</span>
<span class="sd">        ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">    ) g</span>
<span class="sd">    ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND h.EventID = 1</span>
<span class="sd">) i</span>
<span class="sd">ON j.ProcessGuid = i.ProcessGuid</span>
<span class="sd">WHERE j.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND j.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-3-file-deletion">
<h2>9.C.3. File Deletion<a class="headerlink" href="#c-3-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted working.zip (from AppData directory) on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file \AppData\Roaming\working.zip</p>
<div class="section" id="id75">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id75" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:59F37185-0BE4-4D81-8B81-FBFBD8055587</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host j</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT h.ProcessGuid</span>
<span class="sd">    FROM apt29Host h</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT f.ProcessGuid</span>
<span class="sd">        FROM apt29Host f</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT d.ProcessGuid</span>
<span class="sd">          FROM apt29Host d</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">              SELECT b.ProcessGuid</span>
<span class="sd">              FROM apt29Host b</span>
<span class="sd">              INNER JOIN (</span>
<span class="sd">                SELECT ProcessGuid</span>
<span class="sd">                FROM apt29Host</span>
<span class="sd">                WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                    AND EventID = 1</span>
<span class="sd">                    AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">              ) a</span>
<span class="sd">              ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">              WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">          ) c</span>
<span class="sd">          ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">        ) e</span>
<span class="sd">        ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">    ) g</span>
<span class="sd">    ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND h.EventID = 1</span>
<span class="sd">) i</span>
<span class="sd">ON j.ProcessGuid = i.ProcessGuid</span>
<span class="sd">WHERE j.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND j.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-4-file-deletion">
<h2>9.C.4. File Deletion<a class="headerlink" href="#c-4-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted SDelete on disk using cmd.exe del command</p>
<p><strong>Criteria:</strong> cmd.exe deleting the file sdelete64.exe</p>
<div class="section" id="id76">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id76" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0FC62E32-9052-49EB-A5D5-1DF316D634AD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-service-execution">
<h2>10.A.1. Service Execution<a class="headerlink" href="#a-1-service-execution" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed persistent service (javamtsup) on system startup</p>
<p><strong>Criteria:</strong> javamtsup.exe spawning from services.exe</p>
<div class="section" id="id77">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id77" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:CB9F90C0-93EA-469A-9515-7DF27DF1592A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 1</span>
<span class="sd">  AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">  AND Image LIKE &#39;%javamtsup.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:4DABE602-E648-4C1E-81B3-A2AC96F94CE0</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 4688</span>
<span class="sd">  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">  AND NewProcessName LIKE &#39;%javamtsup.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id78">
<h2>10.B.1. Registry Run Keys / Startup Folder<a class="headerlink" href="#id78" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed LNK payload (hostui.lnk) in Startup Folder on user login</p>
<p><strong>Criteria:</strong> Evidence that the file hostui.lnk (which executes hostui.bat as a byproduct) was executed from the Startup Folder</p>
<div class="section" id="id79">
<h3>Detection Type:None(None)<a class="headerlink" href="#id79" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-2-execution-through-api">
<h2>10.B.2. Execution through API<a class="headerlink" href="#b-2-execution-through-api" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed PowerShell payload via the CreateProcessWithToken API</p>
<p><strong>Criteria:</strong> hostui.exe executing the CreateProcessWithToken API</p>
<div class="section" id="id80">
<h3>Detection Type:None(None)<a class="headerlink" href="#id80" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-3-access-token-manipulation">
<h2>10.B.3. Access Token Manipulation<a class="headerlink" href="#b-3-access-token-manipulation" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Manipulated the token of the PowerShell payload via the CreateProcessWithToken API</p>
<p><strong>Criteria:</strong> hostui.exe manipulating the token of powershell.exe via the CreateProcessWithToken API OR powershell.exe executing with the stolen token of explorer.exe</p>
<div class="section" id="id81">
<h3>Detection Type:None(None)<a class="headerlink" href="#id81" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "hunters-forge/ThreatHunter-Playbook",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "notebooks/campaigns"
        }
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="../../evals/apt29/report.html" title="previous page">Free Telemetry Report</a>
    <a class='right-next' id="next-link" href="../windows/windows.html" title="next page">Windows</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2020.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.1.<br/>
    </p>
  </div>
</footer>
</main>


      </div>
    </div>

    <script src="../../_static/js/index.js"></script>
    
  </body>
</html>